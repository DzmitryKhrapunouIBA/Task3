<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="styles/Styles4.css" rel="stylesheet">
    <title>Ekzamenator</title>
</head>
<body>
    <div id="header">
        <h1>Конструктор тестов</h1>
        <p>Вы вошли как: <span id="userName"></span></p>
        <input type="button" value="Выйти" id="RegOut" />
        <div id="nav">
            <ul>
                <li><a href="/homePage.html">Главная</a></li>
                <li><a href="/myTestsPage.html">Мои тесты</a></li>
                <li><a href="#">Пройти тесты</a></li>
                <li><a href="/testCreatorPage.html">Конcтруктов тестов</a></li>
                <li><a href="/testAchievementsPage.html">Просмотр достижений</a></li>
            </ul>
        </div>
    </div>
    <div class="wrapper">
        <div id="article">
            <p>Тема теста: <span id="testName"></span></p>
            <h2>Редактирование вопроса</h2>
            <form name="editForm" method="post" action="/TestEditor/Edit">
                <input type="hidden" name="id" value="0" />
                <div class="form-group col-md-5">
                    <label for="name">Вопрос:</label>
                    <div class="question">
                        <textarea name="question" class="wmd-input" id="question" rows="5"></textarea><br /><br />
                    </div>
                </div>
                <div class="form-group">
                    <label for="age">Ответ1:</label>
                    <input class="response-form" name="answer1" id="answer1" type="text" /><br /><br />
                </div>
                <div class="form-group">
                    <label for="age">Ответ2:</label>
                    <input class="response-form" name="answer2" id="answer2" type="text" /><br /><br />
                </div>
                <div class="form-group">
                    <label for="age">Ответ3:</label>
                    <input class="response-form" name="answer3" id="answer3" type="text" /><br /><br />
                </div>
                <div class="form-group">
                    <label for="age">Ответ4:</label>
                    <input class="response-form" name="answer4" id="answer4" type="text" /><br /><br />
                </div>
                <div class="form-group">
                    <label for="age">Выберите правильный ответ</label>
                    <input class="response-form" name="correctAnswer" type="number" max="4" min="1" /><br /><br />
                </div>
                <div class="panel-body">
                    <button type="submit" id="submit" class="btn btn-primary">Далее</button><br /><br /><br />
                </div>
            </form>
        </div>



        <!--<div id="userInfo">
            <p>Вы вошли как: <span id="userName"></span></p>
            <input type="button" value="Выйти" id="logOut" />
            <input type="button" value="Показать" id="Show" />
        </div>
        <div id="loginForm">
            <div id="header">
                <h1>Вход на сайт</h1>
            </div>
            <div id="card-body">
                <label>Введите логин</label><br />
                <input type="text" id="login" /> <br /><br />
                <label>Введите пароль</label><br />
                <input type="password" id="password" /><br /><br />
                <div id="card-body">
                    <input type="submit" id="submitLogin" value="Логин" /><br /><br />
                </div>-->
            <!--</div>-->










        </div>
        <div id="footer">
            <p>2021 © IBA Task 3</p>
        </div>
        <script>
            var tokenKey = "accessToken";
            var loginKey = "userName";
            var testNameKey = "testName";

            var data = localStorage.getItem(loginKey);

            document.getElementById("userName").innerText = data;

            document.getElementById("RegOut").addEventListener("click", e => {

                e.preventDefault();
                localStorage.removeItem(tokenKey);
                localStorage.removeItem(loginKey);
                location.href = "index.html";
            });
            /*--------------------------------------*/
            // отпавка запроса к контроллеру AccountController для получения токена
            async function getTokenAsync() {

                // получаем данные формы и фомируем объект для отправки
                const formData = new FormData();
                formData.append("login", document.getElementById("login").value);
                formData.append("password", document.getElementById("password").value);

                // отправляет запрос и получаем ответ
                const response = await fetch("/token", {
                    method: "POST",
                    headers: { "Accept": "application/json" },
                    body: formData
                });
                // получаем данные
                const data = await response.json();

                // если запрос прошел нормально
                if (response.ok === true) {

                    // изменяем содержимое и видимость блоков на странице
                    document.getElementById("userName").innerText = data.username;
                    document.getElementById("userInfo").style.display = "block";
                    document.getElementById("loginForm").style.display = "none";
                    // сохраняем в хранилище sessionStorage токен доступа
                    localStorage.setItem(tokenKey, data.access_token);
                    console.log(data.access_token);
                }
                else {
                    // если произошла ошибка, из errorText получаем текст ошибки
                    console.log("Error: ", response.status, data.errorText);
                }
            };
            // отправка запроса к контроллеру ValuesController
            async function getData(url) {
                const token = localStorage.getItem(tokenKey);

                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                        "Authorization": "Bearer " + token  // передача токена в заголовке
                    }
                });
                if (response.ok === true) {

                    const data = await response.json();
                    alert(data)
                }
                else
                    console.log("Status: ", response.status);
            };

            // получаем токен
            document.getElementById("submitLogin").addEventListener("click", e => {

                e.preventDefault();
                getTokenAsync();
            });

            // условный выход - просто удаляем токен и меняем видимость блоков
            document.getElementById("logOut").addEventListener("click", e => {

                e.preventDefault();
                document.getElementById("userName").innerText = "";
                document.getElementById("userInfo").style.display = "none";
                document.getElementById("loginForm").style.display = "block";
                localStorage.removeItem(tokenKey);
            });


            // кнопка получения имя пользователя  - /api/values/getlogin
            document.getElementById("Show").addEventListener("click", e => {

                e.preventDefault();
                getData("/Home/Hello");
            });
        </script>
</body>
</html>