<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="styles/Styles4.css" rel="stylesheet">
    <title>Ekzamenator</title>
</head>
<body>
    <div id="header">
        <h1>Конструктор тестов</h1>
        <p>Вы вошли как: <span id="userName"></span></p>
        <input type="button" value="Выйти" id="RegOut" />
        <div id="nav">
            <ul>
                <li><a href="/homePage.html">Главная</a></li>
                <li><a href="/myTestsPage.html">Мои тесты</a></li>
                <li><a href="#">Пройти тесты</a></li>
                <li><a href="/testCreatorPage.html">Конcтруктов тестов</a></li>
                <li><a href="/testAchievementsPage.html">Просмотр достижений</a></li>
            </ul>
        </div>
    </div>
    <div class="wrapper">
        <div id="article">
            <!--<form name="userForm" id="userForm">                
                <h2>Редактирование вопроса</h2>
                <h2>Список пользователей</h2>                
                <input type="hidden" name="id" value="0" />
                <div class="form-group col-md-5">
                    <label for="name">Имя:</label>
                    <input class="form-control" name="name" />
                </div>
                <div class="form-group col-md-5">
                    <label for="age">Возраст:</label>
                    <input class="form-control" name="age" type="number" />
                </div>
                <div class="panel-body">
                    <button type="submit" id="submit" class="btn btn-primary">Сохранить</button>
                    <a id="reset" class="btn btn-primary">Сбросить</a>
                </div>
            </form>-->
            <table class="table table-condensed table-striped  col-md-6">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Имя</th>
                        <th>возраст</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <div class="panel-body">
                <button type="submit" id="submit">Далее</button><br /><br /><br />
            </div>
            <!--<form name="finishEditForm" id="finishEditForm">
                <p>Тема теста: <span id="testName"></span></p>
                <h2><span id="testName"></span></h2>
            </form>-->
        </div>
    </div>
    <div id="footer">
        <p>2021 © IBA Task 3</p>
    </div>

    <script>
        //document.getElementById("editForm").style.display = "block";
        //document.getElementById("finishEditForm").style.display = "none";

        //document.getElementById("editForm").style.display = "none";
        //document.getElementById("finishEditForm").style.display = "block";

        var tokenKey = "accessToken";
        var loginKey = "userName";

        var user = localStorage.getItem(loginKey);

        document.getElementById("userName").innerText = user;

        document.getElementById("RegOut").addEventListener("click", e => {

            e.preventDefault();
            localStorage.removeItem(tokenKey);
            localStorage.removeItem(loginKey);
            location.href = "index.html";
        });
        /*--------------------------------------*/
                
        async function GetTestsAsync() {

            const formData = new FormData();
            formData.append("login", localStorage.getItem(loginKey));

            const token = localStorage.getItem(tokenKey);
            //const login = localStorage.getItem(loginKey);

            const response = await fetch("/my", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: formData
            });

            //const response = await fetch("/mytests/" + login, {
            //    method: "GET",
            //    headers: {
            //        "Accept": "application/json",
            //        "Authorization": "Bearer " + token
            //    }
            //});

            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const tests = await response.json();
                let rows = document.querySelector("tbody");
                tests.forEach(test => {
                    // добавляем полученные элементы в таблицу
                    rows.append(row(test));
                });
            }
        }

        async function postTestDataAsync() {

            const formData = new FormData();
            formData.append("login", localStorage.getItem(loginKey));

            const token = localStorage.getItem(tokenKey);

            const response1 = await fetch("/myTests", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: formData
            });

            const data = await response1.json();

            if (response1.ok === true) {
                if (data !== null) {

                    for (var i = 0; i < data.length; i++)
                        alert(data[i]);
                }
                else {

                    document.getElementById("editForm").style.display = "none";
                    document.getElementById("finishEditForm").style.display = "block";
                }
            }
            else {

                console.log("Error: ", response1.status, data.errorText);
                alert(data.errorText);
            }
        };

        async function goToNewUrl() {
            const token = localStorage.getItem(tokenKey);

            const response2 = await fetch("/getTestEditorLink", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Authorization": "Bearer " + token
                }
            });

            const url = await response2.json();
            location.href = url;
        };

        document.getElementById("submit").addEventListener("click", e => {

            e.preventDefault();
            GetTestsAsync();
        });
    </script>
</body>
</html>